<link rel="stylesheet" href="style.css" />
<script src="https://cdn.tailwindcss.com"></script>
<div class="flex flex-col gap-4 p-4">
  <div class="flex flex-row justify-between">
    <h1 class="font-semibold">Figma Stats Tracker</h1>

    <button>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        id="cloudsync"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        style="display: none"
        stroke="#ccc"
        class="w-6 h-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z"
        />
      </svg>
    </button>
  </div>
  <div class="border border-b border-gray-100 w-full"></div>
  <button
    id="startpause"
    class="bg-black rounded h-8 text-white text-xs font-bold"
  >
    <span id="startpause_text">Start tracker</span>
  </button>
  <div class="border border-b border-gray-100 w-full"></div>
  <p class="text-sm font-bold uppercase">TRACKED SINCE STARTED</p>

  <div class="grid grid-cols-2 gap-4">
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Groups</p>
      <p class="text-2xl" id="GROUP">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Frames</p>
      <p class="text-2xl" id="FRAME">0</p>
    </div>
  </div>
  <div class="grid grid-cols-2 gap-4">
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Rectangles</p>
      <p class="text-2xl" id="RECTANGLE">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Text</p>
      <p class="text-2xl" id="TEXT">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Ellipses</p>
      <p class="text-2xl" id="ELLIPSE">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Stars</p>
      <p class="text-2xl" id="STAR">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Polygons</p>
      <p class="text-2xl" id="POLYGON">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Slices</p>
      <p class="text-2xl" id="SLICE">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Sections</p>
      <p class="text-2xl" id="SECTION">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Pages</p>
      <p class="text-2xl" id="PAGE">0</p>
    </div>
  </div>

  <div class="border border-b border-gray-100 w-full"></div>
  <p class="text-sm font-bold uppercase">EXISTING ELEMENTS</p>
  <div class="grid grid-cols-2 gap-4">
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Groups</p>
      <p class="text-2xl" id="TOTAL_GROUP">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Frames</p>
      <p class="text-2xl" id="TOTAL_FRAME">0</p>
    </div>
  </div>
  <div class="grid grid-cols-2 gap-4">
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Rectangles</p>
      <p class="text-2xl" id="TOTAL_RECTANGLE">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Text</p>
      <p class="text-2xl" id="TOTAL_TEXT">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Ellipses</p>
      <p class="text-2xl" id="TOTAL_ELLIPSE">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Stars</p>
      <p class="text-2xl" id="TOTAL_STAR">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Polygons</p>
      <p class="text-2xl" id="TOTAL_POLYGON">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Slices</p>
      <p class="text-2xl" id="TOTAL_SLICE">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Sections</p>
      <p class="text-2xl" id="TOTAL_SECTION">0</p>
    </div>
    <div class="flex uppercase font-bold flex-col justify-between">
      <p class="text-xs text-gray-500">Pages</p>
      <p class="text-2xl" id="TOTAL_PAGE">0</p>
    </div>
  </div>
</div>

<script>
  let hasUnsyncedData = false;
  let isStarted = false;
  let countDown = 10;

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelector("#figma_file_name").innerHTML = figma.root.name;
  });

  document.querySelector("#startpause").onclick = () => {
    parent.postMessage({ pluginMessage: "start" }, "*");
    if (!isStarted) {
      document.querySelector("#startpause_text").innerHTML = "Running...";
    } else {
      document.querySelector("#startpause_text").innerHTML = "Start tracker";
      document.querySelector("#startpause_countdown").innerHTML = "";
    }
    isStarted = !isStarted;
  };
  document.querySelector("#cloudsync").onclick = () => {
    parent.postMessage({ pluginMessage: "onsync" }, "*");
  };

  onmessage = (event) => {
    let message = event.data.pluginMessage;
    console.log("message", message);
    onSetStats(message.newNodes);
    onSetAllStats(message.allNodes);
    onSetUnsyncedData(message.hasUnsyncedData);
  };

  function onSetUnsyncedData(_hasUnsyncedData) {
    hasUnsyncedData = _hasUnsyncedData;
    console.log("onSetUnsyncedData", hasUnsyncedData);
    if (hasUnsyncedData) {
      document.querySelector("#cloudsync").style.display = "flex";
    } else {
      document.querySelector("#cloudsync").style.display = "none";
    }
  }

  function onSetStats(nodes) {
    nodes.forEach((node) => {
      var ele = document.querySelector("#" + node.type);
      if (ele) {
        ele.innerHTML = onFindAmount(nodes, node.type);
      }
    });
  }
  function onSetAllStats(nodes) {
    nodes.forEach((node) => {
      var ele = document.querySelector("#TOTAL_" + node.type);
      if (ele) {
        ele.innerHTML = onFindAmount(nodes, node.type);
      }
    });
  }

  function onFindAmount(nodes, type) {
    let amount = 0;
    nodes.forEach((node) => {
      if (node.type === type) {
        amount = node.amount.toLocaleString();
      }
    });
    return amount;
  }
</script>
